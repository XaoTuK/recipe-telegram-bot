#!/usr/bin/env python3
import os
import logging
from telegram import Update, ReplyKeyboardMarkup, ReplyKeyboardRemove
from telegram.ext import (
    Application, 
    CommandHandler, 
    MessageHandler, 
    filters, 
    ContextTypes, 
    ConversationHandler
)
import requests
import json
from enum import Enum

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ Railway
BOT_TOKEN = os.environ['BOT_TOKEN']
YANDEX_API_KEY = os.environ['YANDEX_API_KEY'] 
FOLDER_ID = os.environ['FOLDER_ID']

# URL –¥–ª—è YandexGPT API
YANDEX_GPT_URL = "https://llm.api.cloud.yandex.net/foundationModels/v1/completion"

# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞
class DialogState(Enum):
    AWAITING_PRODUCTS = 1
    AWAITING_DISH_TYPE = 2
    AWAITING_TIME = 3
    AWAITING_PREFERENCES = 4
    AWAITING_PORTIONS = 5

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞
DISH_TYPE_KEYBOARD = [["üç≤ –°–∞–ª–∞—Ç", "üçú –°—É–ø"], ["üçõ –ì–æ—Ä—è—á–µ–µ", "üç∞ –î–µ—Å–µ—Ä—Ç"], ["üé≤ –ü—Ä–µ–¥–ª–æ–∂–∏ –≤–∞—Ä–∏–∞–Ω—Ç"]]
TIME_KEYBOARD = [["üî∏ 15 –º–∏–Ω", "üî∏ 30 –º–∏–Ω"], ["üî∏ 45 –º–∏–Ω", "üî∏ 60 –º–∏–Ω+"], ["‚è∞ –ù–µ –≤–∞–∂–Ω–æ"]]
PORTIONS_KEYBOARD = [["1-2", "3-4"], ["5-6", "7+"]]

# –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–æ –≤—Ä–µ–º—è –¥–∏–∞–ª–æ–≥–∞
user_data = {}

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    # –¢–µ—Å—Ç–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
    logger.info(f"BOT_TOKEN: {bool(BOT_TOKEN)}")
    logger.info(f"YANDEX_API_KEY: {bool(YANDEX_API_KEY)}") 
    logger.info(f"FOLDER_ID: {bool(FOLDER_ID)}")
    
    welcome_text = """
üç≥ *–ü—Ä–∏–≤–µ—Ç! –Ø RecipeChefAI...*

–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —É —Ç–µ–±—è –µ—Å—Ç—å, –∏ —è:
‚Ä¢ –ü—Ä–∏–¥—É–º–∞—é –≤–∫—É—Å–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç üéØ
‚Ä¢ –£—á—Ç—É —Ç–≤–æ–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è ‚≠ê
‚Ä¢ –ü–æ–¥—Å–∫–∞–∂—É –ø–æ –≤—Ä–µ–º–µ–Ω–∏ ‚è±Ô∏è

*–ù–∞–ø—Ä–∏–º–µ—Ä:* `–∫—É—Ä–∏—Ü–∞, —Ä–∏—Å, –ª—É–∫, –º–æ—Ä–∫–æ–≤—å, –ø–æ–º–∏–¥–æ—Ä—ã`

*–ì–æ—Ç–æ–≤ –≥–æ—Ç–æ–≤–∏—Ç—å? –û—Ç–ø—Ä–∞–≤–ª—è–π –ø—Ä–æ–¥—É–∫—Ç—ã!* üöÄ
    """
    await update.message.reply_text(welcome_text, parse_mode='Markdown')
    return DialogState.AWAITING_PRODUCTS

async def handle_products(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤"""
    user_id = update.message.from_user.id
    user_message = update.message.text
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã
    user_data[user_id] = {'products': user_message}
    
    # –°–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–∏–ø –±–ª—é–¥–∞
    await update.message.reply_text(
        "üçΩÔ∏è *–ß—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å?*",
        parse_mode='Markdown',
        reply_markup=ReplyKeyboardMarkup(DISH_TYPE_KEYBOARD, one_time_keyboard=True, resize_keyboard=True)
    )
    
    return DialogState.AWAITING_DISH_TYPE

async def handle_dish_type(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –±–ª—é–¥–∞"""
    user_id = update.message.from_user.id
    dish_type = update.message.text
    
    user_data[user_id]['dish_type'] = dish_type
    
    # –°–ø—Ä–∞—à–∏–≤–∞–µ–º –≤—Ä–µ–º—è
    await update.message.reply_text(
        "‚è±Ô∏è *–°–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç —É –≤–∞—Å –µ—Å—Ç—å –Ω–∞ –≥–æ—Ç–æ–≤–∫—É?*",
        parse_mode='Markdown',
        reply_markup=ReplyKeyboardMarkup(TIME_KEYBOARD, one_time_keyboard=True, resize_keyboard=True)
    )
    
    return DialogState.AWAITING_TIME

async def handle_time(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏"""
    user_id = update.message.from_user.id
    cooking_time = update.message.text
    
    user_data[user_id]['cooking_time'] = cooking_time
    
    # –°–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è
    await update.message.reply_text(
        "üå± *–ï—Å—Ç—å –¥–∏–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏–ª–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è?*\n\n"
        "*–ù–∞–ø—Ä–∏–º–µ—Ä:* –≤–µ–≥–µ—Ç–∞—Ä–∏–∞–Ω—Å–∫–æ–µ, –æ—Å—Ç—Ä–æ–µ, –±–µ–∑ –º–æ–ª–æ—á–Ω–æ–≥–æ, –¥–∏–µ—Ç–∏—á–µ—Å–∫–æ–µ\n"
        "*–ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ:* –Ω–µ—Ç",
        parse_mode='Markdown',
        reply_markup=ReplyKeyboardRemove()
    )
    
    return DialogState.AWAITING_PREFERENCES

async def handle_preferences(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π"""
    user_id = update.message.from_user.id
    preferences = update.message.text
    
    user_data[user_id]['preferences'] = preferences
    
    # –°–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ä—Ü–∏–π
    await update.message.reply_text(
        "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ *–ù–∞ —Å–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫ –≥–æ—Ç–æ–≤–∏–º?*",
        parse_mode='Markdown',
        reply_markup=ReplyKeyboardMarkup(PORTIONS_KEYBOARD, one_time_keyboard=True, resize_keyboard=True)
    )
    
    return DialogState.AWAITING_PORTIONS

async def handle_portions(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –ø–æ—Ä—Ü–∏–π –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ—Ü–µ–ø—Ç–∞"""
    user_id = update.message.from_user.id
    portions = update.message.text
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Ä—Ü–∏–∏ –∏ —É–±–∏—Ä–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    user_data[user_id]['portions'] = portions
    
    await update.message.reply_text(
        "üéØ *–û—Ç–ª–∏—á–Ω–æ! –ì–µ–Ω–µ—Ä–∏—Ä—É—é —Ä–µ—Ü–µ–ø—Ç...*",
        parse_mode='Markdown',
        reply_markup=ReplyKeyboardRemove()
    )
    
    try:
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –±–æ—Ç –ø–µ—á–∞—Ç–∞–µ—Ç
        await update.message.chat.send_action(action="typing")
        
        # –°–æ–∑–¥–∞–µ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º—Ç –¥–ª—è YandexGPT
        user_info = user_data[user_id]
        prompt = create_optimized_prompt(user_info)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ YandexGPT
        recipe_text = await get_recipe_from_yagpt(prompt)
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ—Ü–µ–ø—Ç
        formatted_recipe = format_recipe_response(recipe_text)
        await update.message.reply_text(formatted_recipe, parse_mode='HTML')
        
        # –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        if user_id in user_data:
            del user_data[user_id]
            
    except Exception as e:
        error_message = handle_error(e)
        await update.message.reply_text(error_message)
        
        # –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        if user_id in user_data:
            del user_data[user_id]
    
    return ConversationHandler.END

def create_optimized_prompt(user_info: dict) -> str:
    """–°–æ–∑–¥–∞–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º—Ç –¥–ª—è YandexGPT"""
    
    products = user_info.get('products', '')
    dish_type = user_info.get('dish_type', '')
    cooking_time = user_info.get('cooking_time', '')
    preferences = user_info.get('preferences', '')
    portions = user_info.get('portions', '')
    
    prompt = f"""
–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π —à–µ—Ñ-–ø–æ–≤–∞—Ä. –°–æ–∑–¥–∞–π –∫—É–ª–∏–Ω–∞—Ä–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç –∏—Å–ø–æ–ª—å–∑—É—è —ç—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç—ã: {products}

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è:
- –¢–∏–ø –±–ª—é–¥–∞: {dish_type}
- –í—Ä–µ–º—è –≥–æ—Ç–æ–≤–∫–∏: {cooking_time}
- –ü–æ—Ä—Ü–∏–∏: {portions}
- –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏: {preferences}

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ—Ü–µ–ø—Ç–∞:
1. üçΩÔ∏è –ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞ (–µ–º–æ–¥–∑–∏)
2. üìã –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã (—Ç–æ—á–Ω—ã–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —á–∏—Å–ª–∞ –ø–æ—Ä—Ü–∏–π)
3. üë®‚Äçüç≥ –ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ (—á–µ—Ç–∫–∏–µ –ø—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–µ —à–∞–≥–∏, –º–∞–∫—Å–∏–º—É–º 5 —à–∞–≥–æ–≤)
4. ‚è±Ô∏è –û–±—â–µ–µ –≤—Ä–µ–º—è –≥–æ—Ç–æ–≤–∫–∏
5. üí° –ü–æ–ª–µ–∑–Ω—ã–π —Å–æ–≤–µ—Ç –æ—Ç —à–µ—Ñ–∞

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –†–µ—Ü–µ–ø—Ç –î–û–õ–ñ–ï–ù –±—ã—Ç—å —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º –∏ –≤—ã–ø–æ–ª–Ω–∏–º—ã–º —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º–∏ –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏
- –£—á–∏—Ç—ã–≤–∞–π –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –µ—Å–ª–∏ –æ–Ω–∏ —É–∫–∞–∑–∞–Ω—ã
- –û–±—ä–µ–º: 250-400 —Å–ª–æ–≤
- –Ø–∑—ã–∫: —Ç–æ—Ç –∂–µ —á—Ç–æ –∏ –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –¢–æ–ª—å–∫–æ –∫—É–ª–∏–Ω–∞—Ä–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç, –±–µ–∑ –ª–∏—à–Ω–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
"""
    return prompt

def format_recipe_response(recipe_text: str) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —Ä–µ—Ü–µ–ø—Ç–∞ –≤ –∫—Ä–∞—Å–∏–≤—ã–π HTML"""
    
    # –ë–∞–∑–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
    lines = recipe_text.split('\n')
    formatted_lines = []
    
    for line in lines:
        line = line.strip()
        if not line:
            continue
            
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å—Ç—Ä–æ–∫–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º
        if any(marker in line for marker in ['üçΩÔ∏è', '–ù–∞–∑–≤–∞–Ω–∏–µ', 'ü•ò']):
            formatted_lines.append(f"<b>{line}</b>\n")
        elif any(marker in line for marker in ['üìã', '–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã', 'ü•ï']):
            formatted_lines.append(f"<b>{line}</b>")
        elif any(marker in line for marker in ['üë®‚Äçüç≥', '–ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ', 'üç≥']):
            formatted_lines.append(f"\n<b>{line}</b>")
        elif any(marker in line for marker in ['‚è±Ô∏è', '–í—Ä–µ–º—è', 'üïí']):
            formatted_lines.append(f"\n<b>{line}</b>")
        elif any(marker in line for marker in ['üí°', '–°–æ–≤–µ—Ç', 'üåü']):
            formatted_lines.append(f"\n<b>{line}</b>")
        elif line.startswith(('‚Ä¢', '-', '1.', '2.', '3.', '4.', '5.')):
            formatted_lines.append(f"‚Ä¢ {line.lstrip('‚Ä¢- 12345.')}")
        else:
            formatted_lines.append(line)
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ö–µ—à—Ç–µ–≥–∏ –≤ –∫–æ–Ω–µ—Ü
    formatted_text = '\n'.join(formatted_lines)
    formatted_text += "\n\n#—Ä–µ—Ü–µ–ø—Ç #–≤–∫—É—Å–Ω–æ #–≥–æ—Ç–æ–≤–∏–º–¥–æ–º–∞"
    
    return formatted_text

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û—Ç–º–µ–Ω–∞ –¥–∏–∞–ª–æ–≥–∞"""
    user_id = update.message.from_user.id
    if user_id in user_data:
        del user_data[user_id]
    
    await update.message.reply_text(
        "–î–∏–∞–ª–æ–≥ –æ—Ç–º–µ–Ω–µ–Ω. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ —Å /start",
        reply_markup=ReplyKeyboardRemove()
    )
    return ConversationHandler.END

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–ª—É—á–∞–π–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤–Ω–µ –¥–∏–∞–ª–æ–≥–∞"""
    await update.message.reply_text(
        "–ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç, –Ω–∞—á–Ω–∏—Ç–µ —Å –∫–æ–º–∞–Ω–¥—ã /start üç≥"
    )

async def get_recipe_from_yagpt(prompt: str) -> str:
    """–§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å YandexGPT API"""
    
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Api-Key {YANDEX_API_KEY}",
        "x-folder-id": FOLDER_ID
    }
    
    data = {
        "modelUri": f"gpt://{FOLDER_ID}/yandexgpt-lite",
        "completionOptions": {
            "stream": False,
            "temperature": 0.7,
            "maxTokens": 2000
        },
        "messages": [
            {
                "role": "user",
                "text": prompt
            }
        ]
    }
    
    response = requests.post(YANDEX_GPT_URL, headers=headers, json=data, timeout=30)
    
    if response.status_code != 200:
        error_text = f"HTTP {response.status_code}: {response.text}"
        raise Exception(error_text)
    
    result = response.json()
    
    if ('result' not in result or 
        'alternatives' not in result['result'] or 
        not result['result']['alternatives']):
        raise Exception("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç YandexGPT")
    
    return result['result']['alternatives'][0]['message']['text']

def handle_error(error: Exception) -> str:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –ø–æ–Ω—è—Ç–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏"""
    error_message = str(error)
    logger.error(f"–û—à–∏–±–∫–∞: {error_message}")
    
    if "401" in error_message:
        return "üîê –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ YandexGPT"
    elif "403" in error_message:
        return "üö´ –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω"
    elif "429" in error_message:
        return "‚è≥ –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ"
    elif "500" in error_message:
        return "‚ö° –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ YandexGPT"
    else:
        return "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ—Ü–µ–ø—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑."

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"""
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
        if not all([BOT_TOKEN, YANDEX_API_KEY, FOLDER_ID]):
            logger.error("–ù–µ –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!")
            return
        
        # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        application = Application.builder().token(BOT_TOKEN).build()
        
        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º ConversationHandler –¥–ª—è –º–Ω–æ–≥–æ—à–∞–≥–æ–≤–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
        conv_handler = ConversationHandler(
            entry_points=[CommandHandler("start", start)],
            states={
                DialogState.AWAITING_PRODUCTS: [
                    MessageHandler(filters.TEXT & ~filters.COMMAND, handle_products)
                ],
                DialogState.AWAITING_DISH_TYPE: [
                    MessageHandler(filters.TEXT & ~filters.COMMAND, handle_dish_type)
                ],
                DialogState.AWAITING_TIME: [
                    MessageHandler(filters.TEXT & ~filters.COMMAND, handle_time)
                ],
                DialogState.AWAITING_PREFERENCES: [
                    MessageHandler(filters.TEXT & ~filters.COMMAND, handle_preferences)
                ],
                DialogState.AWAITING_PORTIONS: [
                    MessageHandler(filters.TEXT & ~filters.COMMAND, handle_portions)
                ],
            },
            fallbacks=[CommandHandler("cancel", cancel)]
        )
        
        # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        application.add_handler(conv_handler)
        application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
        logger.info("–ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
        application.run_polling(
            drop_pending_updates=True,
            allowed_updates=Update.ALL_TYPES
        )
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞: {e}")

if __name__ == "__main__":
    main()
