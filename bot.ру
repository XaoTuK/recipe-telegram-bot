import os
import requests
from telegram import Update
from telegram.ext import Application, MessageHandler, filters, ContextTypes

YANDEX_API_KEY = "AQVN21SkiHPTzTQ7PRtnMipVWr17W-hEv0WNqn8c"
TELEGRAM_TOKEN = "8462003240:AAEzP4drh3jb6FErp26qr_HaRMjQF9i1OII"
FOLDER_ID = "b1gne1sf06u2lnsieuk9"

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        products = update.message.text
        await update.message.reply_text(f"üîç –ò—â—É —Ä–µ—Ü–µ–ø—Ç –¥–ª—è: {products}...")
        
        headers = {
            "Authorization": f"Api-Key {YANDEX_API_KEY}",
            "Content-Type": "application/json"
        }
        
        data = {
            "modelUri": f"gpt://{FOLDER_ID}/yandexgpt",
            "messages": [{
                "role": "user", 
                "text": f"–ü—Ä–∏–¥—É–º–∞–π —Ä–µ—Ü–µ–ø—Ç –∏–∑: {products}. –§–æ—Ä–º–∞—Ç: 1.–ù–∞–∑–≤–∞–Ω–∏–µ 2.–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã 3.–ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ"
            }]
        }
        
        response = requests.post(
            "https://llm.api.cloud.yandex.net/foundationModels/v1/completion", 
            json=data, 
            headers=headers,
            timeout=30
        )
        
        if response.status_code == 200:
            recipe = response.json()['result']['alternatives'][0]['message']['text']
            await update.message.reply_text(f"üç≥ {recipe}")
        else:
            await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ API –Ø–Ω–¥–µ–∫—Å")
            
    except Exception as e:
        await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")

app = Application.builder().token(TELEGRAM_TOKEN).build()
app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

if __name__ == "__main__":
    print("‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –Ω–∞ Railway!")
    app.run_polling()
